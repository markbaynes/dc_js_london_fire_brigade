<!DOCTYPE html>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <lang="en">
    <meta name="description" content="London Fire Brigade Incidents - DC.js">
    <meta name="author" content="Mark Baynes">
    <title>LFB Data</title>
    <link type="text/css" rel="stylesheet" href="css/custom-styles.css">
    <link type="text/css" rel="stylesheet" href="css/normalize.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.0/dc.min.css" integrity="sha256-WHvgKNpdomdSPf4EGBla0Wx7QZpnZyKAOvuHQcuMHNs=" crossorigin="anonymous" />    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/3.0.6/dc.min.js.map"></script>

<!-- D3 CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js" integrity="sha256-uB5nPcWK8vr5e83snqtMUYJ2n/5TZ3PV9CCRk1pzob4=" crossorigin="anonymous"></script>
<!-- D3 Tip CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.5.1/d3.tip.min.js" integrity="sha256-KIFAHEltVn0Vi1KDBgX+s2phAhqrQXlyWlTJlH9NUxA=" crossorigin="anonymous"></script>
 <!-- JQuery CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<!-- Crossfilter CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.1.0/crossfilter.js" integrity="sha256-ytRavWq0RDB67VtsUW5vbogo2y8gSiYdXEl90Y+EDnE=" crossorigin="anonymous"></script>
<!-- DC CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.0/dc.js" integrity="sha256-TCayy3w2u6MkusNgPnN1SqzgLOQRxlthmspBqQ2dpLU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.0/dc.js.map"></script>
<!-- Bootstrap CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.1.0/bootstrap.min.js" integrity="sha256-oFFqVfuP76DUEv+GuxqdrCgD+0GYiB9x6wh9KoJ3pAw=" crossorigin="anonymous"></script>


</head>

  <body>
<a href="https://github.com/markbaynes"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
    <div class="container">

      <div class="page-header">
        <h2>London Fire Brigade Incidents | DC v2.1.0 | D3 3.5.16 | Leaflet </h2>
      </div>
  <div class="row">
    <div class="col-xs-9">
      <p>This is a work in progress and as such has a <strong>minimal sampled</strong> LFB dataset for development purposes. Not responsive.</p>
    </div>
    <div class="col-xs-3">       
      <span class="label label-warning"><a href="javascript:dc.filterAll(); dc.redrawAll();">Reset All</a></span>
  </div>

  </div>  
     
      <div class="row">  <!--row -->
        <div id="map-holder">
        <div class="col-xs-3" id="busy-stations-chart"><h4>Busiest LFB stations</h4></div>
        <div class="col-xs-9" id="map" ></div>
      </div>
      </div> <!--/ row -->

      <div class="row">  <!--row -->
        <div class="col-xs-12"  id="incident-dates-area-chart"><h3>Number of incidents between <span class="filter"></span></h3>
          <span class="label label-warning"><a href="javascript:dc.filterAll(); dc.redrawAll();">Reset All</a></span>
        </div>
      </div> <!--/ row -->
      
      <div class="row">  <!--row -->
        <div class="col-xs-12" id="navigation-chart"><h4>Navigator (select and drag to horizontal scroll the chart above)</h4></div>
      </div> <!--/ row -->

      <div class="row">  <!--row -->
        <div class="col-xs-3" id="dc-days-chart"><h3>Daily incidents</h3></div>

        <div class="col-xs-3" id="dc-fires-pie-chart"><h3>Fire incidents</h3></div>

        <div class="col-xs-3" id="dc-false-pie-chart"><h3>False alarms</h3></div>

        <div class="col-xs-3"><h3>H3 Header</h3><p>Etiam himenaeos dapibus aptent dolor luctus ultricies praesent vivamus felis ullamcorper at id sed arcu duis ante ex suspendisse nisl cursus eu nunc neque amet molestie. </p>
        <p>Aliquam elit lectus fringilla quis adipiscing interdum molestie quisque leo.</p></div>
      </div> <!--/ row -->

       <div class="row">  <!--row -->
        <div class="col-xs-12" id="response-chart"><h3>Response time distribution</h3><a href="javascript:dc.filterAll(); dc.redrawAll();">Reset All</a></div>
      </div> <!--/ row -->

       <div class="row">  <!--row -->
        <div class="col-xs-12" id="heat-chart"><h3>Heat map number of incidents by day of week / borough</h3>
         <span class="label label-warning"><a href="javascript:dc.filterAll(); dc.redrawAll();">Reset All</a></span>
       </div>
      </div> <!--/ row -->

    <div class="row dataTable"
        <div class="col-xs-12 text-rightla"> 
        <h4>Data table</h4> <span class="label label-warning"><a href="javascript:dc.filterAll(); dc.redrawAll();">Reset All</a></span>
                <table class='table table-hover' id="basicTable">
                    <thead>
                        <tr class='header'>
                            <th>Lorem ipsum</th>
                            <th>Lorem ipsum</th>
                            <th>Lorem ipsum</th>
                            <th>Lorem ipsum</th>
                            <th>Lorem ipsum</th>
                            <th>Lorem ipsum</th>
                            <th>Lorem ipsum</th>
                            <th>Lorem ipsum</th>

                        </tr>
                    </thead>
                </table>
            </div>

      <div class="row">  <!--row -->
        <div class="col-xs-4"><h4>Footer A</h4><p>Non placerat litora dui nibh ut vel gravida duis suspendisse molestie enim pellentesque nunc leo</p></div>
        <div class="col-xs-4"><h4>Footer B</h4><p>Non placerat litora dui nibh ut vel gravida duis suspendisse molestie enim pellentesque nunc leo</p></div>
        <div class="col-xs-4"><h4>Footer C</h4><p>Non placerat litora dui nibh ut vel gravida duis suspendisse molestie enim pellentesque nunc leo</p></div>
      </div> <!--/ row -->
    </div> <!-- / main container -->

<!-- DC.js code -->

  <script>


// var thisDate = d3.time.format("%Y-%m-%d");


// Function to convert call time p.callTime to string then get the hours

function getCallHour(x){
      var y = x.toString();
      var h = y.substring(0, 2);
    return h;
}


 d3.csv("data/LFB-test-data-main.csv", function (data) {
   console.log(data);
   initDc(data);
 });

/*
    d3.csv("filename.csv", function (data) {
        data.forEach(function (d)
                  d.callDate = new Date(Date.parse(d.dateOfCall));
        d.weekDay = d.dayOfWeek;
        d.callTime = d.timeOfCall;
        d.callHour = getCallHour(d.callTime);
        d.incidentType = d.incidentGroup;
        d.stopCode = d.stopCodeDescription;
        d.categoryProperty = d.propertyCategory;
        d.propertyX = d.propertyType;
        d.postCodeShort = d.postcodeDistrict;
        d.boroName = d.geoBoroughName;
        d.latitude = parseFloat(d.Lat);
        d.longitude = parseFloat(d.Lon);
        d.incidentStation = d.incidentStationGround;
        d.firstPumpTime = d.firstPumpArrivingAttendanceTime;
        d.numPumps = +d.numPumpsAttending;
    });

*/
 

      var dataset = crossfilter(data);
      var all = dataset.groupAll();

//  Chart anchors definition

      var incidentDatesChart = dc.lineChart("#incident-dates-area-chart");
      var navigationChart = dc.barChart("#navigation-chart");
      var daysChart = dc.rowChart("#dc-days-chart");
      var falseChart = dc.pieChart("#dc-false-pie-chart");
      var firesChart = dc.pieChart("#dc-fires-pie-chart");
      var busyStationsChart = dc.rowChart("#busy-stations-chart");
      var responseChart = dc.barChart("#response-chart");
      var heatMapChart = dc.heatMap("#heat-chart");


 // Main Dimensions

 var allDim = dataset.dimension(function(d) {return d;});
      

     var incidentDatesA = dataset.dimension(function(d){
              return d.callDate;
          });

      var incidentDatesGroupA = incidentDatesA.group().reduceCount(function(d) { return d.callDate; });

      var incidentDatesB = dataset.dimension(function(d){
              return d.callDate;
          });

      var incidentDatesGroupB = incidentDatesB.group();
 
     
      incidentDatesChart
          .width(750)
          .height(250)
          .margins({top: 10, right: 10, bottom: 30, left: 40})
          .renderArea(false)
          .brushOn(false)
          .dimension(incidentDatesA)
          .group(incidentDatesGroupA)
          .rangeChart(navigationChart)
          .round(d3.time.month.round)
          .xUnits(d3.time.days)
          .elasticX(true)
          .x(d3.time.scale().domain([new Date(2012, 01, 1), new Date(2015, 10, 31)]))
          .renderHorizontalGridLines(true);



// Navigation bar chart controls incidentDatesChart above.     

      navigationChart  
          .width(750)
          .height(60)
          .margins({top: 10, right: 10, bottom: 30, left: 40})
          .dimension(incidentDatesB)
          .group(incidentDatesGroupB)
          .gap(50)
          .x(d3.time.scale().domain([new Date(2012, 01, 1), new Date(2015, 10, 31)]))
          .round(d3.time.month.round)
          .xUnits(d3.time.days)
          .alwaysUseRounding(true)
          .yAxis()
          .tickValues([]);

          navigationChart.on("renderlet", function (chart) {
             navigationChart.select("g.y").style("display", "none");
               incidentDatesChart.filter(chart.filter());
                })
          .on("filtered", function (chart) {
             dc.events.trigger(function () {
                incidentDatesChart.focus(chart.filter());
              });
          });   


//  Number of incidents by day of week row chart.

var daysDimension = dataset.dimension(function (d) { 
        return d.dayOfWeek;
        });

        var daysGroup = daysDimension.group();

//  Incidents by day row chart.

        daysChart
              // .width(200)
              // .height(220)
              .margins({top: 5, left: 30, right: 10, bottom: 20})
              .dimension(daysDimension)
              .group(daysGroup)
              .label(function (d){
                    return d.key;
                    })
              .title(function(d){return d.value;})
              .elasticX(true)
              .xAxis()
              .ticks(6);



//  Pie charts. Why? Because people like them.
//  False alarms pie chart

         var falseIncidents = dataset.dimension(function(d){
              if (d.incidentGroup == "False Alarm")
                return "False alarms";
              else
                return "Genuine calls"  
          });

var falseIncidentsGroup = falseIncidents.group();

        falseChart
            // .width(220)
            // .height(180)
            .radius(80)
            .innerRadius(25)
            .dimension(falseIncidents)
            .group(falseIncidentsGroup)
            .title(function(d){return d.value;});

 falseChart.ordinalColors(['Brown', 'IndianRed']);

//  Fires pie chart

var firesIncidents = dataset.dimension(function(d){
              if (d.incidentGroup == "Fire")
                return "Fire";
              else
                return "Other"  
          });

         var firesIncidentsGroup = firesIncidents.group();

        firesChart
            // .width(220)
            // .height(180)
            .radius(80)
            .innerRadius(25)
            .dimension(firesIncidents)
            .group(firesIncidentsGroup)
            .title(function(d){return d.value;});

        firesChart.ordinalColors(['Peru', 'DarkKhaki']);

//  Busiest top N stations row chart.

var busiestStations = dataset.dimension(function(d){
                  return d.firstPumpArrivingDeployedFromStation;
            });


 var busiestStationsGroup = busiestStations.group();

        busyStationsChart
              .width(205)
              .height(450)
              .margins({top: 0, left: 10, right: 50, bottom: 20})
              .dimension(busiestStations)
              .cap(20)
              .othersGrouper(false)
              .group(busiestStationsGroup)
              .ordinalColors(['DarkOrange', 'MediumSeaGreen', 'SaddleBrown', 'Sienna','DarkGoldenRod'])
              .label(function (d){
                    return d.key;
                    })
              .title(function(d){return d.value;})
              .elasticX(true)
              .xAxis().ticks(6);


//  Histogram response times


var responseDimension = dataset.dimension(function(d){
              return d.firstPumpTime;
});

var responseGroupCount = responseDimension.group().reduceCount(function(d) { return d.firstPumpTime; });

responseChart.xUnits(dc.units.fp.precision(binwidth));

var binwidth = 200;

 responseChart
          // .width(900)
          // .height(250)
          .margins({top: 10, right: 10, bottom: 30, left: 50})
          .dimension(responseDimension)
          .group(responseGroupCount)
          .transitionDuration(500)
          .brushOn(true)
          .renderHorizontalGridLines(true)
          .renderVerticalGridLines(false)
         .x(d3.scale.linear().domain([7, 800]))  // Dynamic, not fixed. 
       //   .x(d3.scale.linear().domain(d3.extent(responseDimension, function(d) { return d.firstPumpTime; })))
          .elasticY(true)
          .xAxisLabel("Response time (seconds)")  // This!
          .yAxisLabel("Number of LFB responses")
          .xAxis()
          .tickFormat();


          d3.format(".0f")(-30.6499023) // "−30.65"

          responseChart.xAxis().tickFormat(function (v) {return v + "s";}); 

//  Heat Map - Quantities of incident per Borough per day



      heatDimension = dataset.dimension(function(d) { return [d.boroName, d.weekDay]; }),

      heatDimensionGroup = heatDimension.group().reduceCount(function(d) { return d.callDate; });

var heatColorMapping = d3.scale.threshold()
            .domain([10,20,30,40,50])
            .range(['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15']); 

// ['#fff5f0','#fee0d2','#fcbba1','#fc9272','#fb6a4a','#ef3b2c','#cb181d','#a50f15','#67000d'] // Colorbrewer 9 step sequential single hue. 
// ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15'] Colorbrewer 2 single hue 5 step

// ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15']); // Colorbrewer 5 step sequential single hue. 


  heatMapChart
    // .width(700)
    .height(660)
    .margins({top: 10, right: 10, bottom: 20, left: 170})
    .dimension(heatDimension)
    .group(heatDimensionGroup)
    .colsLabel(function(d) { return d;})
    .rowsLabel(function(d) { return d;})
    .keyAccessor(function(d) { return d.key[1]; })
    .valueAccessor(function(d) { return d.key[0]; })
    .colorAccessor(function(d) { return d.value; })
    .title(function(d) {
        return "Borough: " + d.key[0] + "\n" +
               "Day:" + d.key[1] + "\n" +
               "Number of incidents: " + d.value; })
    .colors(heatColorMapping)
    .xBorderRadius(0)
    .yBorderRadius(0);



//  Data count

var incidentsCount = dc.dataCount("#dc-data-count")
        .dimension(dataset)
        .group(all);


//  Data table

    basicTable = dc.dataTable("#basicTable")
        .dimension(incidentDatesA)
        .group(all)
        .group(function (d) { return thisDate(d.callDate);
        })
        .size(10)
        .columns([
    {
        label: "Date",
        format: function (d) { return thisDate(d.callDate); }
    },
    {
        label: "Time",
        format: function (d) { return (d.callTime); } 
    },
    {
        label: "Day of week",
        format: function (d) { return (d.weekDay); } 
    },
    {
        label: "Incident Type",
        format: function (d) { return (d.incidentType); }
    },
    {
        label: "Property Type",
        format: function (d) { return d.categoryProperty; }
    },
    {
        label: "Borough",
        format: function (d) { return d.boroName; }
    },
    {
        label: "Post Code",
        format: function (d) { return d.postCodeShort; }
    },

    {
        label: "Incident Station",
        format: function (d) { return d.incidentStation; }
    }
      ])
    .order(d3.ascending);

     
//  Leaflet
  

var map = L.map('map');

var drawMap = function(){

    map.setView([51.522327, -0.129091], 10);
    mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
 var tiles = L.tileLayer(
            'https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFya2JheW5lcyIsImEiOiJDZkgzOXBvIn0.6yrMg-LLplHUzVx0SkPDTQ', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 18,
        }).addTo(map);


    var geoData = [];
    _.each(allDim.top(Infinity), function (d) {
        geoData.push([d["latitude"], d["longitude"], d["numPumps"]]);
    });
    var heat = L.heatLayer(geoData,{
        radius: 10,
        blur: 20, 
        maxZoom: 1,
    }).addTo(map);

    map.on("contextmenu", function (event) {
  console.log("user right-clicked on map coordinates: " + event.latlng.toString());
  L.marker(event.latlng).addTo(map);


// call DC.js event with latlng. 

});

};

drawMap();

dcCharts = [incidentDatesChart, navigationChart, daysChart, falseChart, firesChart, busyStationsChart, responseChart, heatMapChart];

_.each(dcCharts, function (dcChart) {
    dcChart.on("filtered", function (chart, filter) {
        map.eachLayer(function (layer) {
          map.removeLayer(layer)
        }); 
    drawMap();
    });
});
 // Leaflet
     

              function print_filter(filter){
                  var f=eval(filter);
                  if (typeof(f.length) != "undefined") {}else{}
                  if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
                  if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
                  console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
                  //  Print filter.

        dc.renderAll();
      });



    </script> <!-- / DC.js code -->
  
  </body>
</html>
